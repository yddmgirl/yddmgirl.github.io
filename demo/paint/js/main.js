function makePhoto(){var e=createFormDate(8);$(".make-img").attr("data-filter",8),$(".spinner").show(),sendPhoto(e,function(e){if(e){$(".spinner").hide();var a=e.url,t=new Image;t.src=a,t.onload=function(){$(".make-page").addClass("disappear").removeClass("hide");var n=document.getElementById("file-upload");getOrientation(n.files[0],function(n){var r,i,o=$(".make-pic").width(),s=t.width>t.height?t.height/t.width:t.width/t.height;t.width==t.height?(r=o,i=o):t.width<t.height?(r=o*s,i=o):(r=o,i=o*s);for(var c=[3,4,5,6,7,8],p=0;p<c.length;p++)c[p]==n&&(r/=s,i/=s);switch(n){case 3:$(".make-pic").css("transform","rotate(-180deg)");break;case 4:$(".make-pic").css("transform","rotate(180deg)");break;case 5:$(".make-pic").css("transform","rotate(-90deg)");break;case 6:$(".make-pic").css("transform","rotate(90deg)");break;case 7:$(".make-pic").css("transform","rotate(90deg)");break;case 8:$(".make-pic").css("transform","rotate(-90deg)")}$(".make-img").css({width:r+"px",height:i+"px","margin-left":"-"+r/2+"px","margin-top":"-"+i/2+"px"}),$(".make-img").attr("src",a),$(".upload-bg").css("background-image","url("+a+")");var m=e.result,g=makePoemHMTL(m[0],e.haspoem);$(".poem-word").html(g),$(".btn-change").hide(),e.haspoem?($(".shake-word").html(""),m.length>1&&$(".btn-change").show()):$(".shake-word").html("似乎没有匹配的诗词"),$(".main-page").addClass("hide"),$(".make-page").removeClass("disappear"),$(".pop-tips").removeClass("hide"),setTimeout(function(){$(".pop-tips").addClass("disappear"),$(".make-img").attr("data-filter",8)},2e3),changePoem(m)})}}});var a=!0;return changeFilter(a),!1}function createFormDate(e){var a=new FormData;return a.append("upload_image",$("#file-upload")[0].files[0]),a.append("user","abc"),a.append("style_id",e),a}function sendPhoto(e,a){$.ajax({type:"post",url:"https://asr.qq.com/upd_py/imgPoemCgi.py",data:e,cache:!1,processData:!1,contentType:!1,dataType:"json",success:function(e){a(e)}})}function makePoemHMTL(e,a){var t="",e=e.replace(/；|;|？|\?|\,|\.| /g,"");if(a){t="<span>"+e.replace(/。/g,"<i>。</i></span><span>").replace(/，/g,"<i>，</i></span><span>").replace(/：/g,'<i class="mh">：</i></span><span>').replace(/、/g,"<i>、</i></span><span>")}else if(e.length>8){for(var n=e.split(""),r=parseInt(n.length/8),i=1;i<=r;i++)n.splice(9*i-1,0,"</span><span>");t="<span>"+n.join("")+"</span>"}else t="<span>"+e+"</span>";return t}function changeFilter(e){var a=document.querySelector(".make-item"),t=new Hammer(a);t.on("swipe",function(a){if(a.deltaX<0){if($(".pop-tips").addClass("disappear"),setTimeout(function(){$(".pop-tips").addClass("invisible")},1e3),!e)return;e=!1;var t;if(8==$(".make-img").attr("data-filter")){var n=createFormDate(374);t=374}else{var n=createFormDate(8);t=8}$(".pop-tips").hasClass("invisible")?$(".spinner").show():setTimeout(function(){$(".spinner").show()},600),sendPhoto(n,function(a){if(a){$(".make-img").attr("data-filter",t);var n=a.url;$(".make-img").attr("src",n),$(".upload-bg").css("background-image","url("+n+")"),$(".spinner").hide(),setTimeout(function(){e=!0},500)}})}return!1})}function HtmlToCanvas(e,a){html2canvas(document.querySelector(e),{onrendered:function(e){a(e)},allowTaint:!0,scale:4})}function convertCanvasToImage(e){var a=new Image;return a.src=e.toDataURL("image/png"),a}function changePoem(e){var a=1;$(".btn-change").on("click",function(){a==e.length&&(a=0);var t=makePoemHMTL(e[a],1);$(".poem-word").html(t),a++})}function getTranditionalTime(){function e(e,a){return e>>a&1}function a(){s=3!=arguments.length?new Date:new Date(arguments[0],arguments[1],arguments[2]);var a,t,n,m,g=!1,h=s.getYear();for(h<1900&&(h+=1900),a=365*(h-1921)+Math.floor((h-1921)/4)+p[s.getMonth()]+s.getDate()-38,s.getYear()%4==0&&s.getMonth()>1&&a++,t=0;;t++){for(m=c[t]<4095?11:12,n=m;n>=0;n--){if(a<=29+e(c[t],n)){g=!0;break}a=a-29-e(c[t],n)}if(g)break}r=1921+t,i=m-n+1,o=a,12==m&&(i==Math.floor(c[t]/65536)+1&&(i=1-i),i>Math.floor(c[t]/65536)+1&&i--)}function t(){var e="";return e+=m.charAt((r-4)%10),e+=g.charAt((r-4)%12),e+="",e+="年",e+=i<1?l.charAt(-i-1):l.charAt(i-1),e+="月",e+=o<11?"初":o<20?"十":o<30?"廿":"三十",o%10==0&&10!=o||(e+=h.charAt((o-1)%10)),e}function n(e,n,r){return e<1921||e>2020?"":(n=parseInt(n)>0?n-1:11,a(e,n,r),t())}var r,i,o,s,c=new Array(100),p=new Array(12),m="甲乙丙丁戊己庚辛壬癸",g="子丑寅卯辰巳午未申酉戌亥",h="一二三四五六七八九十",l="正二三四五六七八九十冬腊";c=new Array(2635,333387,1701,1748,267701,694,2391,133423,1175,396438,3402,3749,331177,1453,694,201326,2350,465197,3221,3402,400202,2901,1386,267611,605,2349,137515,2709,464533,1738,2901,330421,1242,2651,199255,1323,529706,3733,1706,398762,2741,1206,267438,2647,1318,204070,3477,461653,1386,2413,330077,1197,2637,268877,3365,531109,2900,2922,398042,2395,1179,267415,2635,661067,1701,1748,398772,2742,2391,330031,1175,1611,200010,3749,527717,1452,2742,332397,2350,3222,268949,3402,3493,133973,1386,464219,605,2349,334123,2709,2890,267946,2773,592565,1210,2651,395863,1323,2707,265877),p[0]=0,p[1]=31,p[2]=59,p[3]=90,p[4]=120,p[5]=151,p[6]=181,p[7]=212,p[8]=243,p[9]=273,p[10]=304,p[11]=334;var u=new Date,d=u.getFullYear(),f=u.getMonth()+1,v=u.getDate();u.getDay(),parseInt(u.getTime()/1e3);d<100&&(d="19"+d);var $=n(d,f,v);return $}function getOrientation(e,a){var t=new FileReader;t.onload=function(e){var t=new DataView(e.target.result);if(65496!=t.getUint16(0,!1))return a(-2);for(var n=t.byteLength,r=2;r<n;){var i=t.getUint16(r,!1);if(r+=2,65505==i){if(1165519206!=t.getUint32(r+=2,!1))return a(-1);var o=18761==t.getUint16(r+=6,!1);r+=t.getUint32(r+4,o);var s=t.getUint16(r,o);r+=2;for(var c=0;c<s;c++)if(274==t.getUint16(r+12*c,o))return a(t.getUint16(r+12*c+8,o))}else{if(65280!=(65280&i))break;r+=t.getUint16(r,!1)}}return a(-1)},t.readAsArrayBuffer(e.slice(0,65536))}$(function(){$("#file-upload").on("change",function(){makePhoto()}),$(".btn-save").on("click",function(){HtmlToCanvas(".make-item",function(e){e.style.width="100%",e.style.height="auto";var a=convertCanvasToImage(e);if($(".photo-wrap").append(a),a){var t="micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i);t?wx.ready(function(){wx.previewImage({current:a.src,urls:[a.src]})}):($(".photo-wrap").html(a),$(".photo-show").removeClass("hide"),$(".photo-show").on("click",function(){return $(".photo-show").addClass("hide"),!1}))}})});var e=getTranditionalTime();$(".current-time").html(e)});